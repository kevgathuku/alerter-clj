name: Generate Jekyll Posts

on:
  # Run daily at 3am UTC to consolidate previous day's alerts
  schedule:
    - cron: "0 3 * * *" # Daily at 3am UTC

  # Allow manual trigger with optional specific date
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to generate post for (YYYY-MM-DD, defaults to yesterday)'
        required: false
        type: string
      run_id:
        description: 'Specific workflow run ID to download artifacts from (for debugging)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-jekyll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          lein: latest

      - name: Cache Leiningen dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2
            ~/.lein
          key: ${{ runner.os }}-lein-${{ hashFiles('project.clj') }}
          restore-keys: |
            ${{ runner.os }}-lein-

      # Download all alert artifacts from the alerts workflow
      - name: Download alert artifacts (specific run)
        if: ${{ github.event.inputs.run_id != '' }}
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: alerts.yml
          name: alerts-.*
          name_is_regexp: true
          path: content/
          search_artifacts: true
          workflow_conclusion: success
          run_id: ${{ github.event.inputs.run_id }}

      - name: Download alert artifacts (latest from branch)
        if: ${{ github.event.inputs.run_id == '' }}
        uses: dawidd6/action-download-artifact@v11
        with:
          workflow: alerts.yml
          name: alerts-.*
          name_is_regexp: true
          path: content/
          search_artifacts: true
          branch: main
          workflow_conclusion: success

      - name: List downloaded artifacts
        run: |
          echo "Contents of content/ directory:"
          ls -laR content/ || echo "content/ directory not found"

      - name: Flatten artifact structure
        run: |
          # Move files from content/alerts-*/... to content/...
          if [ -d "content" ]; then
            for artifact_dir in content/alerts-*; do
              if [ -d "$artifact_dir" ]; then
                echo "Moving contents from $artifact_dir to content/"
                cp -r "$artifact_dir"/* content/
                rm -rf "$artifact_dir"
              fi
            done
          fi
          echo "Final content structure:"
          ls -laR content/ || echo "content/ directory not found"

      - name: Generate Jekyll post
        run: |
          # Use provided date or default to yesterday
          DATE="${{ github.event.inputs.date }}"
          if [ -z "$DATE" ]; then
            # Get yesterday's date
            DATE=$(date -d "yesterday" '+%Y-%m-%d')
          fi
          echo "Generating Jekyll post for $DATE"
          echo "POST_DATE=$DATE" >> $GITHUB_ENV
          lein generate-jekyll $DATE

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-checkout

      - name: Copy generated post to gh-pages
        run: |
          cp blog/_posts/*.markdown gh-pages-checkout/blog/_posts/

      - name: Commit and push Jekyll post
        working-directory: gh-pages-checkout
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add blog/_posts/*.markdown
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: Add alert report for ${{ env.POST_DATE }}"
            git push
            echo "Successfully pushed to gh-pages"
          fi
