name: Generate Jekyll Posts

on:
  # Run daily at 3am UTC to consolidate previous day's alerts
  schedule:
    - cron: "0 3 * * *" # Daily at 3am UTC

  # Allow manual trigger with optional specific date
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to generate post for (YYYY-MM-DD, defaults to yesterday)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-jekyll:
    runs-on: ubuntu-latest

    steps:
      # Checkout main branch which contains both application code and content
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Set up Clojure
        uses: DeLaGuardo/setup-clojure@13.4
        with:
          lein: latest

      - name: Cache Leiningen dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2
            ~/.lein
          key: ${{ runner.os }}-lein-${{ hashFiles('project.clj') }}
          restore-keys: |
            ${{ runner.os }}-lein-

      - name: Generate Jekyll post
        run: |
          # Use provided date or default to yesterday
          DATE="${{ github.event.inputs.date }}"
          if [ -z "$DATE" ]; then
            # Get yesterday's date
            DATE=$(date -d "yesterday" '+%Y-%m-%d')
          fi
          echo "Generating Jekyll post for $DATE"
          echo "POST_DATE=$DATE" >> $GITHUB_ENV
          lein generate-jekyll $DATE

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-repo

      - name: Copy generated post to gh-pages
        run: |
          mkdir -p gh-pages-repo/_posts
          cp blog/_posts/*.markdown gh-pages-repo/_posts/
          echo "Copied posts to gh-pages branch"

      - name: Commit and push to gh-pages
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "docs: Add alert report for ${{ env.POST_DATE }}"
          repository: ./gh-pages-repo
          branch: gh-pages
